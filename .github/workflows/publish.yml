name: Release & Publish

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build package
        run: yarn prepare

  release:
    needs:
      - lint
      - build
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup
        uses: ./.github/actions/setup

      - name: Determine version bump
        id: bump
        run: |
          # Find the latest version tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            # No tags yet â€” use all commits
            COMMITS=$(git log --pretty=format:"%s" --no-merges)
          else
            COMMITS=$(git log "${LATEST_TAG}..HEAD" --pretty=format:"%s" --no-merges)
          fi

          if [ -z "$COMMITS" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "No new commits since last release, skipping."
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "Commits since ${LATEST_TAG:-beginning}:"
          echo "$COMMITS"

          # Determine bump type from conventional commits
          BUMP="patch"

          if echo "$COMMITS" | grep -qiE "^feat(\(.+\))?!:|BREAKING CHANGE"; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qiE "^feat(\(.+\))?:"; then
            BUMP="minor"
          fi

          echo "type=$BUMP" >> "$GITHUB_OUTPUT"
          echo "Bump type: $BUMP"

      - name: Bump version
        if: steps.bump.outputs.skip != 'true'
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          BUMP_TYPE="${{ steps.bump.outputs.type }}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Bumping $CURRENT_VERSION -> $NEW_VERSION ($BUMP_TYPE)"

          # Update package.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${NEW_VERSION}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Commit version bump
        if: steps.bump.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: release v${{ steps.version.outputs.version }} [skip ci]"
          git push

      - name: Build package
        if: steps.bump.outputs.skip != 'true'
        run: yarn prepare

      - name: Create GitHub Release
        if: steps.bump.outputs.skip != 'true'
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          generate_release_notes: true

      - name: Update npm for OIDC support
        if: steps.bump.outputs.skip != 'true'
        run: npm install -g npm@latest

      - name: Publish to npm
        if: steps.bump.outputs.skip != 'true'
        run: npm publish --provenance --access public
